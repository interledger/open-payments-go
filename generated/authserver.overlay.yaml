overlay: 1.0.0
info:
  title: Name Grant request body and branches (no discriminator)
  version: 0.2.0
x-speakeasy-jsonpath: rfc9535

extends: ../open-payments-specifications/openapi/auth-server.yaml

actions:
  # Named schema for access token in grant requests
  - target: $.components.schemas
    update:
      AccessTokenRequest:
        type: object
        description: The requested access permissions for the grant.
        required: [access]
        properties:
          access:
            $ref: "#/components/schemas/access"

      GrantRequestWithAccessToken:
        type: object
        properties:
          client:
            $ref: "#/components/schemas/client"
          interact:
            $ref: "#/components/schemas/interact-request"
          access_token:
            $ref: "#/components/schemas/AccessTokenRequest"
          subject:
            $ref: "#/components/schemas/subject"
        required: [client, access_token]

      GrantRequestWithSubject:
        type: object
        properties:
          client:
            $ref: "#/components/schemas/client"
          interact:
            $ref: "#/components/schemas/interact-request"
          access_token:
            $ref: "#/components/schemas/AccessTokenRequest"
          subject:
            $ref: "#/components/schemas/subject"
        required: [client, interact, subject]

      # Named union instead of "PostRequestJSONBody"
      GrantRequestBody:
        oneOf:
          - $ref: "#/components/schemas/GrantRequestWithAccessToken"
          - $ref: "#/components/schemas/GrantRequestWithSubject"

  # Named requestBody using the union
  - target: $.components
    update:
      requestBodies:
        GrantRequest:
          required: true
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GrantRequestBody"

  # Specify requestBody on POST /
  - target: $.paths["/"].post.requestBody
    update:
      $ref: "#/components/requestBodies/GrantRequest"
